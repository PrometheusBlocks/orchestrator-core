<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>PrometheusBlocks WebUI</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <style>
      body {
        background: #121212;
        color: #fff;
        font-family: 'Roboto', Arial, sans-serif;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        min-height: 100vh;
        margin: 0;
      }
      input {
        padding: 8px;
        width: 300px;
        background: #333;
        color: #fff;
        border: 1px solid #555;
      }
      button {
        margin-left: 8px;
        padding: 8px 12px;
      }
      ul {
        list-style: none;
        padding: 0;
      }
      li {
        margin-top: 8px;
      }
      .link-button {
        background: none;
        border: none;
        color: #4da3ff;
        cursor: pointer;
        text-decoration: underline;
        font-size: 1em;
      }
      .utility-card {
        background: #1e1e1e;
        padding: 12px;
        margin: 10px 0;
        border-radius: 4px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        width: 100%;
        max-width: 600px;
      }
      .plan-text {
        font-family: 'Roboto', Arial, sans-serif;
        font-size: 1.1em;
        color: #ddd;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>
    <script type="text/babel">
      function App() {
        const [prompt, setPrompt] = React.useState('');
        const [plan, setPlan] = React.useState(null);
        const [utilities, setUtilities] = React.useState([]);
        const [proposed, setProposed] = React.useState([]);
        const [contracts, setContracts] = React.useState({});
        const [error, setError] = React.useState('');

        const handleSubmit = async (e) => {
          e.preventDefault();
          setError('');
          setUtilities([]);
          setContracts({});
          setProposed([]);
          setPlan(null);
          try {
            const res = await fetch('/plan', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ prompt }),
            });
            if (!res.ok) throw new Error('Planning failed');
            const data = await res.json();
            setPlan(data);
            let utils = [];
            if (Array.isArray(data)) {
              utils = data.map((s) => s.action);
            } else if (data && Array.isArray(data.resolved)) {
              utils = data.resolved;
            }
            setUtilities(utils);
            if (data && Array.isArray(data.proposed_utilities)) {
              setProposed(data.proposed_utilities);
            }
          } catch (err) {
            setError(err.toString());
          }
        };

        const fetchContract = async (name) => {
          if (contracts[name]) return;
          try {
            const res = await fetch(`/utility/${name}`);
            if (!res.ok) throw new Error('Utility not found');
            const contract = await res.json();
            setContracts((c) => ({ ...c, [name]: contract }));
          } catch (err) {
            setContracts((c) => ({ ...c, [name]: { error: err.toString() } }));
          }
        };

        return (
          <div>
            <h1>What do you want to build?</h1>
            <form onSubmit={handleSubmit}>
              <input
                value={prompt}
                onChange={(e) => setPrompt(e.target.value)}
              />
              <button type="submit">Plan</button>
            </form>
            {error && <p style={{ color: 'red' }}>{error}</p>}
            {plan && (
              <div>
                <h2>Execution Plan</h2>
                {plan.plan && <p className="plan-text">{plan.plan}</p>}
                <pre style={{ whiteSpace: 'pre-wrap' }}>
                  {JSON.stringify(plan, null, 2)}
                </pre>
              </div>
            )}
            <h2>Blocks</h2>
            <ul>
              {utilities.map((u) => (
                <li key={u}>
                  <details onToggle={(e) => { if (e.target.open) fetchContract(u); }}>
                    <summary>{u}</summary>
                    {contracts[u] ? (
                      contracts[u].error ? (
                        <p style={{ color: 'red' }}>{contracts[u].error}</p>
                      ) : (
                        <pre style={{ whiteSpace: 'pre-wrap' }}>
                          {JSON.stringify(contracts[u], null, 2)}
                        </pre>
                      )
                    ) : (
                      <p>Loading...</p>
                    )}
                  </details>
                </li>
              ))}
            </ul>
            {proposed.length > 0 && (
              <div style={{ width: '100%', maxWidth: '600px' }}>
                <h2>Proposed Utilities</h2>
                {proposed.map((u) => (
                  <div key={u.name} className="utility-card">
                    <h3>{u.name}</h3>
                    <p>{u.description}</p>
                    {u.entrypoints && (
                      <div>
                        <strong>Entrypoints:</strong>
                        <ul>
                          {u.entrypoints.map((ept) => (
                            <li key={ept.name}>
                              {ept.name}: {ept.description}
                            </li>
                          ))}
                        </ul>
                      </div>
                    )}
                  </div>
                ))}
              </div>
            )}
          </div>
        );
      }

      ReactDOM.render(<App />, document.getElementById('root'));
    </script>
  </body>
</html>
